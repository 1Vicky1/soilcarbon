---
title: "Soil Carbon Quality Control"
author: "J Grey Monroe"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

Quality control (QC) of data input is an important step to ensure that the datasets are properly strucutred, contain necessary information, and that values are appropriately entered for each variable. This vignette will provide a guide for users to perform QC checks on datasets to be uploaded to the soilcarbon database. 

This QC procedure is perfomed directly in R, using functions in the `soilcarbon` package. This package is currently under development and can be found at https://github.com/powellcenter-soilcarbon/soilcarbon.

# Quick start

Open R and run the following lines of code. You will be prompted with a window to select the file with which you want to perform QC. A report will be saved in the same directory as the data file you select.

```{r, eval=F}
install.packages("devtools") # you only need to run this line once on your computer
devtools::install_github("powellcenter-soilcarbon/soilcarbon") # running this line will install the latest version of the soilcarbon package
library(soilcarbon) # this needs to be run in every new R session
my_dataset<-read.soilcarbon(file=file.choose()) 
dataQC(my_dataset, writeQCreport = T)
```

  
# Extended Guide
A more comprehensive explanation of the quality control features are explained in this extended guide. 

## Installing the soilcarbon package

To install `soilcarbon` we will use the package `devtools`, which allows us to install R packages in development on github. To install `devtools` we first run the following code. You only need this run this once on your computer.

```{r, eval=F}
install.packages("devtools")
```

Now we are ready to install `soilcarbon` from it's home on github. To do this, just run this code. Because the package is in development, it will undergo updates, so this code should be run regularly to keep up as the package gains new features.

```{r, eval=F}
devtools::install_github("powellcenter-soilcarbon/soilcarbon")
```

Now that you have the `soilcarbon` package installed, everytime you want to use it in a new R session, run this code.

```{r, eval=T}
library(soilcarbon)
```

## Loading dataset into R

To load your dataset into R, we use the `read.soilcarbon()` function. To use this function, you need direct the `file` parameter to your soilcarbon datset. Here we are using the `file.choose()` command, which opens a window for you to find your file wherever it is saved. The code will look like this:

```{r, eval=F}
my_dataset<-read.soilcarbon(file=file.choose())
```

```{r, eval=T, echo=FALSE}
data_file<-system.file("extdata", "Sollins_2006.xlsx", package ="soilcarbon")
my_dataset<-read.soilcarbon(file=data_file)
```

In this example, we have read in a dataset file called "Sollins_2006.xlsx". Now we will perform a QC check on this dataset.

## Performing QC on dataset

To perform a QC check on our dataset, we will use the `dataQC()` function. This function being developed, but currently perfoms the following checks.

1. Compares column names between the tabs in the input data and the tabs in the standard data template, which is currently "UNALTERED_TEMPLATE_v120616.xlsx". If the column names do not match, a warning message will be issued, and the discrepancies printed.
1. Checks for consistancy in names at different hierarchical levels in the data. For example, the *site_names* in the **site** tab, should match those found in the **profile**, **layer**, and **fraction** tabs. `dataQC` checks the names of each level. If they do not match, a warning message is issued, and the names at each level are printed.

Additional QC checks will be added as needed. Please feel free to email Grey Monroe at greymonroe@gmail.com, with suggestions.

To perform the QC, run the following code

```{r, eval=F, results='hide'}
dataQC(my_dataset)
```
Running `dataQC` in this way will return the output of the check to the R console like the output shown below

```{r, eval=T, echo=F}
dataQC(my_dataset)
```

The output provides warnings when the problems in the dataset are detected. As we can see, dataQC has warned us about several issues with this dataset.  

Looking at the COLUMN NAMES check we see a couple of warnings.  

1. First, there are two columns in the **layer** tab that are not found in the template: *"course_tot"* and *"course_size_thresh"*. It appears that they are simply misspelled, as the template file has very similar column names that are not found in the dataset: *"coarse_tot"* and *"coarse_size_thresh"*  
1. Second, there are several columns in the **fraction** tab that are missing from the template. 

The output from the LEVEL NAMES check also returns a few warnings

1. First, the dataset names dont seem to match across levels. Specifically, we see that the **fraction** tab has a dataset name called "sollins_2006," which does not match the dataset names in the other tabs which are "Sollins_2006." It is important that the names match both in characters and the same pattern of upper/lower case.  
1. Second, the site names do not match. This time it is because the site name in the **site** tab is missing the "s" in "Andrews."

After the problems are corrected in the datafile, you should reload it with `read.soilcarbon` and run `dataQC` again.

## Generating QC report
We can save the output of the dataQC report to a text file, adding `writeQCreport = T` to the `dataQC` function. 

```{r, eval=F, echo=T}
dataQC(my_dataset, writeQCreport = T)
```

By default, the file is saved to the same folder where the data was loaded, and is named by adding "_QCreport.txt" to the data file name. 


